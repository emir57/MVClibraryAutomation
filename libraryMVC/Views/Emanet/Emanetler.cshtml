@model IEnumerable<libraryMVC.Dtos.EmanetDto>
@using System;
@using System.Collections.Generic;
@using System.Diagnostics;


<div class="jumbotron mt-5">
    <h2 style="float:left;" class="text-info">Emanet Listesi</h2>
    <div class="searchSection">
        <input class="form-control" style="max-width: 100px;" placeholder="ID" id="id" type="number" />&nbsp;
        <input class="form-control" style="max-width: 200px;" placeholder="Ara" id="searchString" type="text" />
    </div>
    <table class="table table-hover mt-3 table-striped">
        <thead>
            <th>Emanet No</th>
            <th>Üye Ad Soyad</th>
            <th>Kitap Ad</th>
            <th>Emanet Verme Tarihi</th>
            <th>Emanet Geri Alma Tarihi</th>
            <th>Emanet İşlem Tarihi </th>
            <th>Emanet Not</th>
            <th>Emanet Teslim Edildi</th>
            <th width="155px">İşlemler</th>
        </thead>
        <tbody id="emanetler">

        </tbody>
        @* @foreach (var item in Model)
            {
            string userUrl = Url.Action("Uyeler", "Uye") + "#" + item.Uye.UyeNo;
            string kitapUrl = Url.Action("Kitaplar", "Kitap") + "#" + item.Kitap.KitapNo;
            <tr>
            <td>@item.EmanetNo</td>
            <td>
            <a href="@userUrl">@item.Uye.UyeAd @item.Uye.UyeSoyad</a>
            </td>
            <td>
            <a href="@kitapUrl">@item.Kitap.KitapAd</a>
            </td>
            <td>@item.EmanetVermeTarih</td>
            <td>@item.EmanetGeriAlmaTarih</td>
            <td>@item.EmanetIslemTarih</td>
            <td>
            @if (@item.EmanetNot.Contains("^") == true)
            {
            <p>-</p>
            }
            else
            {
            @item.EmanetNot
            }

            </td>
            <td>

            @if (@item.EmanetTeslimEdildi == "Sürüyor")
            {
            <p class="text-primary">Sürüyor.</p>
            }
            else if (@item.EmanetTeslimEdildi == "Teslim Edildi")
            {
            <p class="text-success">Teslim Edildi.</p>
            }
            else
            {
            <p class="text-danger">Teslim Edilmedi.</p>
            }
            </td>
            <td>

            </td>
            </tr>

            } *@

    </table>

</div>
<a style="float:left; margin-bottom:100px;" asp-action="CreateEmanetler"
    class="btn btn-outline-secondary btn-sm mx-2">Yeni Emanet Oluştur</a>

@section Scripts{
<script>
    //GetAll
    $(document).ready(function () {
        getAll();
    })
    //GetById
    $(document).ready(function () {
        let emanetler = $("#emanetler");
        $("#id").keyup(function () {
            if ($(this).val()) {
                $.ajax({
                    url: "/Emanet/EmanetlerSearchById?id=" + $(this).val(),
                    method: "GET",
                    success: function (data) {
                        let html = getData(data);
                        emanetler.empty().append(html);
                    },
                    error: function (error) {
                        if (error.responseText === "Not Found") {
                            showErrorAlert("Böyle bir emanet yok");
                        }
                    }
                })
            } else {
                getAll();
            }
        })
    })

    //GetBySearchString
    $(document).ready(function () {
        let emanetler = $("#emanetler");
        $("#searchString").keyup(function () {
            if ($(this).val()) {
                $.ajax({
                    url: "/Emanet/EmanetlerSearchBySearchString?searchString=" + $(this).val(),
                    method: "GET",
                    success: function (datas) {
                        let html = getDatas(datas);
                        emanetler.empty().append(html);
                    }
                })
            } else {
                getAll();
            }
        })
    })

    function getDatas(datas) {
        let html = "";
        datas.forEach(data => {
            let emanetClass = "";
            if (data.emanetTeslimEdildi === "Sürüyor") { emanetClass = "text-primary"; }
            else if (data.emanetTeslimEdildi === "Teslim Edildi") { emanetClass = "text-success"; }
            else if (data.emanetTeslimEdildi === "Teslim Edilmedi") { emanetClass = "text-danger"; }
            html += `
                <tr id="${data.emanetNo}">
                    <td>${data.emanetNo}</td>
                    <td>
                        <a href="/Uye/Uyeler#${data.uye.uyeNo}">${data.uye.uyeAd} ${data.uye.uyeSoyad}</a>
                    </td>
                    <td>
                        <a href="/Kitap/Kitaplar#${data.kitap.kitapNo}">${data.kitap.kitapAd}</a>
                    </td>
                    <td>${data.emanetVermeTarih}</td>
                    <td>${data.emanetGeriAlmaTarih}</td>
                    <td>${data.emanetIslemTarih}</td>
                    <td>${data.emanetNot}</td>
                    <td>
                        <p class="${emanetClass}">${data.emanetTeslimEdildi}</p>
                    </td>
                    <td>
                        <!-- Button trigger modal -->
                        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#modal${data.emanetNo}">
                            Sil
                        </button>
                        <a class="btn btn-primary text text-white" href="/Emanet/EditEmanetler/${data.emanetNo}"
                        role="button">Düzenle</a>
                        <!-- Modal -->
                        <div class="modal fade" id="modal${data.emanetNo}" role="dialog" tabindex="-1"
                        aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Kayıt Siliniyor</h5>
                                        <button type="button" class="btn-close" data-dismiss="modal"
                                        aria-label="Close">X</button>
                                    </div>
                                    <div class="modal-body">
                                        <span class="text-danger">${data.emanetNo} - ${data.emanetTeslimEdildi}</span>
                                        <br>
                                        Bu Kaydı Silmek İstediğinizden Emin misiniz?
                                    </div>
                                    <div class="modal-footer">
                                        <a class="btn  btn-secondary text text-white" data-dismiss="modal"
                                        role="button">İptal</a>
                                        <a class="btn btn-danger text text-white" asp-action="DeleteEmanetler"
                                        asp-route-id="${data.emanetNo}" role="button">Sil</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        })
        return html;
    }
    function getData(data) {
        let emanetClass = "";
        if (data.emanetTeslimEdildi === "Sürüyor") { emanetClass = "text-primary"; }
        else if (data.emanetTeslimEdildi === "Teslim Edildi") { emanetClass = "text-success"; }
        else if (data.emanetTeslimEdildi === "Teslim Edilmedi") { emanetClass = "text-danger"; }
        let html = `
                <tr id="${data.emanetNo}">
                    <td>${data.emanetNo}</td>
                    <td>
                        <a href="/Uye/Uyeler#${data.uye.uyeNo}">${data.uye.uyeAd} ${data.uye.uyeSoyad}</a>
                    </td>
                    <td>
                        <a href="/Kitap/Kitaplar#${data.kitap.kitapNo}">${data.kitap.kitapAd}</a>
                    </td>
                    <td>${data.emanetVermeTarih}</td>
                    <td>${data.emanetGeriAlmaTarih}</td>
                    <td>${data.emanetIslemTarih}</td>
                    <td>${data.emanetNot}</td>
                    <td>
                        <p class="${emanetClass}">${data.emanetTeslimEdildi}</p>
                    </td>
                    <td>
                        <!-- Button trigger modal -->
                        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#modal${data.emanetNo}">
                            Sil
                        </button>
                        <a class="btn btn-primary text text-white" href="/Emanet/EditEmanetler/${data.emanetNo}"
                        role="button">Düzenle</a>
                        <!-- Modal -->
                        <div class="modal fade" id="modal${data.emanetNo}" role="dialog" tabindex="-1"
                        aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Kayıt Siliniyor</h5>
                                        <button type="button" class="btn-close" data-dismiss="modal"
                                        aria-label="Close">X</button>
                                    </div>
                                    <div class="modal-body">
                                        <span class="text-danger">${data.emanetNo} - ${data.emanetTeslimEdildi}</span>
                                        <br>
                                        Bu Kaydı Silmek İstediğinizden Emin misiniz?
                                    </div>
                                    <div class="modal-footer">
                                        <a class="btn  btn-secondary text text-white" data-dismiss="modal"
                                        role="button">İptal</a>
                                        <a class="btn btn-danger text text-white" asp-action="DeleteEmanetler"
                                        asp-route-id="${data.emanetNo}" role="button">Sil</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        return html;
    }

    function getAll() {
        let emanetler = $("#emanetler");
        $.ajax({
            url: "/Emanet/EmanetlerSearchBySearchString?searchString=" + $("#searchString").val(),
            method: "GET",
            success: function (datas) {
                let html = getDatas(datas);
                emanetler.empty().append(html);
            },
            error: function (error) {
                if (error.responseText === "Not Found") {
                    showErrorAlert("Böyle bir emanet yok");
                }
            }
        })
    }
</script>
}
